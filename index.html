<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagrama POS Gasolinera</title>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
  </script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hint { color: #666; margin-top: -8px; margin-bottom: 14px; font-size: 14px; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      max-width: 720px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }
    .modal-body { padding: 14px 16px; line-height: 1.45; }
    .modal-body ul { margin-top: 8px; }
    .close-btn {
      border: none; background: #eee; padding: 8px 10px;
      border-radius: 10px; cursor: pointer; font-weight: 600;
    }
    .close-btn:hover { background: #e3e3e3; }
    .tag { display:inline-block; font-size: 12px; background:#f2f2f2; padding:3px 8px; border-radius:999px; margin-right:6px; }
  </style>
</head>

<body>
  <h2>Diagrama de Contexto – Punto de Venta</h2>
  <div class="hint">Tip: hacé clic en una caja (Infile, Fusion, Servidor Central, etc.) para ver la explicación.</div>

  <div class="mermaid">
flowchart LR
  POS["Punto de Venta (POS) - Estación A<br/>──────────────<br/>Market | Bombas"]
  POS2["Punto de Venta (POS) - Estación B<br/>──────────────<br/>Market | Bombas"]

  FE["Infile Factura Electrónica"]
  FUS["Fusion (Control Bombas)"]
  PUMPS["Bombas / Dispensadores"]
  INV["Sistema Inventario Físicos"]
  REC["Sistema Producción y Recetas"]
  SC["Servidor Central (Multi-Estación)"]
  SAP["SAP Business One"]

  POS -->|"JSON factura"| FE
  FE -->|"Respuesta FE (OK/Error)"| POS

  POS <-->|"Autoriza despacho / lecturas / totales"| FUS
  FUS <-->|"Liberar bomba / datos despacho"| PUMPS

  POS <-->|"Movimientos / tomas físicas / kardex"| INV
  POS <-->|"Recetas / consumo / producción"| REC
  POS <-->|"Datos / ventas / sincronización"| SC
  POS2 <-->|"Datos / ventas / sincronización"| SC

  SC <-->|"Integración"| SAP

  %% Click actions -> navigates to an anchor (hash)
  click FE "#infile"
  click FUS "#fusion"
  click PUMPS "#bombas"
  click INV "#inventario"
  click REC "#recetas"
  click SC "#central"
  click SAP "#sap"
  click POS "#pos"
  click POS2 "#pos2"
  </div>

  <!-- Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div id="modalTitle">Detalle</div>
        <button class="close-btn" id="closeBtn">Cerrar ✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

 <script>
  const DETAILS = {
    infile: {
      title: "Infile – Factura Electrónica",
      body: `
        <h3>Integración con INFILE</h3>

        <p>
          El sistema de Punto de Venta (POS) genera un archivo en formato <b>JSON</b>, el cual es enviado a <b>INFILE</b>.
          Este sistema se encarga de validar la información y enviarla a certificación ante Hacienda.
        </p>

        <p>
          En caso de que exista algún error durante la validación, INFILE retorna un mensaje de error al POS para su corrección.
          Si el sistema POS funciona correctamente, no deberían presentarse errores durante este proceso.
        </p>
      `
    },

    fusion: {
      title: "Fusion – Control de Bombas",
      body: `
        <h3>Integración con FUSION</h3>

        <p>
          El Punto de Venta (POS) se integra con <b>FUSION</b> para autorizar el despacho de combustible.
          Al registrar una venta, el POS envía la solicitud indicando la bomba y el volumen de galones a dispensar.
        </p>

        <p>
          La integración también se utiliza para pruebas de combustible y auditorías de economía, permitiendo controlar y registrar los despachos efectuados.
        </p>
      `
    },

    bombas: {
      title: "Bombas / Dispensadores",
      body: `
        <p>
          Equipo físico de despacho. Recibe autorización desde Fusion y devuelve datos del consumo real (volumen, total, estado).
        </p>
      `
    },

    inventario: {
      title: "Sistema de Inventario Físicos",
      body: `
        <h3>Integración con HYPERION</h3>

        <p>
          El Punto de Venta (POS) genera un archivo <b>CSV</b> con el catálogo completo de productos del Market, incluyendo la existencia teórica (<i>on hand</i>) de cada artículo.
        </p>

        <p>
          El dispositivo <i>hand held</i> descarga este archivo para ejecutar el proceso de inventario físico, utilizando información como código, descripción y cantidades teóricas.
        </p>

        <p>
          Al finalizar el conteo, el sistema permite comparar el inventario físico contra el inventario teórico, generando reportes de diferencias para su validación.
        </p>
      `
    },

    recetas: {
      title: "Sistema de Producción y Recetas",
      body: `
        <h3>Integración con Sistema de Recetas</h3>

        <p>
          El sistema de Punto de Venta (POS) utiliza el sistema de recetas para realizar el descargue del inventario de los materiales utilizados en la preparación de productos.
        </p>

        <p>
          En el caso de productos estándar, el descargue de inventario se realiza al momento de la venta.
          Sin embargo, para productos de comida preparada, el descargue de los materiales se realiza al momento de su fabricación, conforme a la receta establecida.
        </p>
      `
    },

    central: {
      title: "Servidor Central (Multi-Estación)",
      body: `
        <h3>Integración con Servidor Central</h3>

        <p>
          El sistema de Punto de Venta (POS) recibe desde el <b>Servidor Central</b> información como listas de precios, catálogo de artículos, usuarios, promociones y otros parámetros necesarios para la operación.
        </p>

        <p>
          De forma bidireccional, el POS envía al Servidor Central las transacciones realizadas, movimientos de inventario, información de Kardex y demás datos operativos generados en la estación.
        </p>
      `
    },

    sap: {
      title: "SAP Business One",
      body: `
        <h3>Integración del Servidor Central con SAP</h3>

        <p>
          El <b>Servidor Central</b> permite parametrizar los niveles de consolidación de datos que serán transmitidos al sistema <b>SAP</b>, facilitando la integración con los procesos administrativos y contables.
        </p>

        <p>
          Asimismo, el Servidor Central recibe desde SAP información maestra necesaria para la operación de los puntos de venta, incluyendo catálogo de productos, proveedores y configuraciones relacionadas.
        </p>
      `
    },

    pos: {
      title: "Punto de Venta (POS) – Estación A",
      body: `
        <p>
          Registra ventas de <b>Market</b> y <b>Combustible</b>. Orquesta el proceso: cobra, factura y sincroniza.
        </p>
      `
    },

    pos2: {
      title: "Punto de Venta (POS) – Estación B",
      body: `
        <p>
          Otro POS adicional para demostrar que el Servidor Central atiende varias estaciones/tiendas.
        </p>
      `
    }
  };

  const backdrop = document.getElementById("backdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const closeBtn = document.getElementById("closeBtn");

  function openModal(key) {
    const info = DETAILS[key];
    if (!info) return;
    modalTitle.textContent = info.title;
    modalBody.innerHTML = info.body;
    backdrop.style.display = "flex";
  }

  function closeModal() {
    backdrop.style.display = "none";
    history.replaceState(null, "", window.location.pathname + window.location.search);
  }

  function checkHash() {
    const key = window.location.hash.replace("#", "");
    if (key) openModal(key);
  }

  window.addEventListener("hashchange", checkHash);
  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  checkHash();
</script>
